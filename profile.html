<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UnityPass Profile</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <img src="images/Unitypass.png" alt="UnityPass Logo" class="logo">
  <h1>Your UnityPass Profile</h1>
  <p class="slogan">One Skill. One Identity</p>
</header>

<main>
  <div id="profileContainer"></div>
</main>

<!-- Load JS Libraries -->
<script src="js/qrcode.min.js"></script>
<script src="js/jspdf.umd.min.js"></script>

<script>
const API_URL = 'https://api.sheetbest.com/sheets/6370568b-e4ec-43f3-b14d-13875e2b5bfe';
const container = document.getElementById('profileContainer');

// ‚úÖ Get phone number from URL
const urlParams = new URLSearchParams(window.location.search);
const currentPhone = urlParams.get('phone');
console.log('üì± Current phone:', currentPhone);

async function loadWorkers() {
  try {
    const res = await fetch(API_URL);
    const workers = await res.json();
    console.log('üìã Fetched workers:', workers);

    // ‚úÖ Match the user by Phone exactly
    const userWorker = workers.find(
      w => String(w.Phone).trim() === String(currentPhone).trim()
    );
    console.log('üë§ Matched user:', userWorker);

    if (userWorker) {
      displayWorker(userWorker);
    } else {
      container.innerHTML = '<p style="color:red">‚ùå Profile not found.</p>';
    }
  } catch (err) {
    console.error('‚ùå Error loading profile:', err);
    container.innerHTML = '<p style="color:red">üö® Failed to load profile.</p>';
  }
}

function displayWorker(worker) {
  const safeId = (worker.Name || 'no-name').replace(/\s+/g, '_');

  container.innerHTML = `
    <div class="id-card">
      <input type="text" id="name-${safeId}" value="${worker.Name}" placeholder="Full Name"><br>
      <input type="text" id="skill-${safeId}" value="${worker.Skill}" placeholder="Skill"><br>
      <input type="text" id="phone-${safeId}" value="${worker.Phone}" disabled><br>
      <input type="text" id="location-${safeId}" value="${worker.Location}" placeholder="Location"><br>
      <button id="update-${safeId}">Update Profile</button>
      <button id="download-${safeId}">Download PDF</button>
      <div class="qr-code" id="qr-${safeId}"></div>
      <p id="msg-${safeId}"></p>
    </div>
  `;

  // ‚úÖ Generate QR Code
  new QRCode(document.getElementById(`qr-${safeId}`), {
    text: `Name: ${worker.Name}\nSkill: ${worker.Skill}\nPhone: ${worker.Phone}\nLocation: ${worker.Location}`,
    width: 130,
    height: 130
  });

  // ‚úÖ Update profile
  document.getElementById(`update-${safeId}`).addEventListener('click', async () => {
    const updatedWorker = {
      Name: document.getElementById(`name-${safeId}`).value.trim(),
      Skill: document.getElementById(`skill-${safeId}`).value.trim(),
      Location: document.getElementById(`location-${safeId}`).value.trim()
    };

    try {
      // First, fetch data again to get _rowNumber
      const resAll = await fetch(API_URL);
      const allWorkers = await resAll.json();
      const row = allWorkers.find(w => String(w.Phone).trim() === String(worker.Phone).trim());

      if (!row || !row._rowNumber) {
        alert('‚ö†Ô∏è Row not found for update.');
        return;
      }

      const res = await fetch(`${API_URL}/${row._rowNumber}`, {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(updatedWorker)
      });

      const msgEl = document.getElementById(`msg-${safeId}`);
      if (res.ok) {
        msgEl.style.color = 'green';
        msgEl.textContent = '‚úÖ Profile updated successfully!';
        // Regenerate QR
        document.getElementById(`qr-${safeId}`).innerHTML = '';
        new QRCode(document.getElementById(`qr-${safeId}`), {
          text: `Name: ${updatedWorker.Name}\nSkill: ${updatedWorker.Skill}\nPhone: ${worker.Phone}\nLocation: ${updatedWorker.Location}`,
          width: 130,
          height: 130
        });
      } else {
        msgEl.style.color = 'red';
        msgEl.textContent = '‚ùå Failed to update profile.';
      }
    } catch (error) {
      console.error('Update error:', error);
      document.getElementById(`msg-${safeId}`).textContent = '‚ùå Network error';
    }
  });

  // ‚úÖ Download as PDF
  document.getElementById(`download-${safeId}`).addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'mm', format: 'a6' });
    doc.setFontSize(14);
    doc.text(`Name: ${document.getElementById(`name-${safeId}`).value}`, 10, 20);
    doc.setFontSize(12);
    doc.text(`Skill: ${document.getElementById(`skill-${safeId}`).value}`, 10, 30);
    doc.text(`Phone: ${worker.Phone}`, 10, 40);
    doc.text(`Location: ${document.getElementById(`location-${safeId}`).value}`, 10, 50);
    doc.save(`${document.getElementById(`name-${safeId}`).value}_UnityPass.pdf`);
  });
}

// ‚úÖ Load the profile on page load
loadWorkers();
</script>

</body>
</html>