<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UnityPass Profile</title>
<link rel="stylesheet" href="style.css">
<script src="js/qrcode.min.js"></script>
<script src="js/jspdf.umd.min.js"></script>
</head>
<body>

<header>
  <div class="logo-container">
    <div class="logo-circle">
      <img src="images/Unitypass.png" alt="UnityPass Logo" class="logo-img">
    </div>
    <div class="logo-text">UNITYPASS</div>
    <div class="logo-slogan">One Skill. One Identity</div>
  </div>
</header>

<main>
  <input type="text" id="phoneInput" placeholder="Search by Phone, Name or Area">
  <button id="findBtn">Find Profile</button>
  <button id="downloadAllBtn" style="background:#4CAF50;color:white;">Download All PDFs</button>
  <div id="profileContainer"></div>
</main>

<script>
const API_URL = 'https://api.sheetbest.com/sheets/6370568b-e4ec-43f3-b14d-13875e2b5bfe';
const searchInput = document.getElementById('phoneInput');
const findBtn = document.getElementById('findBtn');
const container = document.getElementById('profileContainer');
const downloadAllBtn = document.getElementById('downloadAllBtn');
let workers = [];

// Load all workers
async function loadWorkers() {
    try {
        const res = await fetch(API_URL);
        const data = await res.json();
        workers = Array.isArray(data) ? data : [];
    } catch(err){
        container.innerHTML = '<p style="color:red">Failed to load workers.</p>';
    }
}

// Display multiple editable worker profiles
function displayWorkers(workerArray) {
    container.innerHTML = '';
    if(workerArray.length === 0) {
        container.innerHTML = '<p style="color:#666">No workers found.</p>';
        return;
    }

    workerArray.forEach(worker => {
        const safeId = (worker.Name || 'no-name').replace(/\s+/g,'_');
        const card = document.createElement('div');
        card.className = 'id-card';
        card.innerHTML = `
            <input type="text" id="nameField-${safeId}" value="${worker.Name}" placeholder="Full Name"><br>
            <input type="text" id="skillField-${safeId}" value="${worker.Skill}" placeholder="Skill"><br>
            <input type="text" id="phoneField-${safeId}" value="${worker.Phone}" placeholder="Phone Number" disabled><br>
            <input type="text" id="locationField-${safeId}" value="${worker.Location}" placeholder="Location"><br>
            <button id="updateBtn-${safeId}">Update Profile</button>
            <button id="downloadBtn-${safeId}">Download PDF</button>
            <div class="qr-code" id="qr-${safeId}"></div>
            <p id="msg-${safeId}"></p>
        `;
        container.appendChild(card);

        // Generate QR code
        new QRCode(document.getElementById(`qr-${safeId}`), {
            text: `Name: ${worker.Name}\nSkill: ${worker.Skill}\nPhone: ${worker.Phone}\nLocation: ${worker.Location}`,
            width: 130,
            height: 130
        });

        // Update profile
        document.getElementById(`updateBtn-${safeId}`).addEventListener('click', async () => {
            const updatedWorker = {
                Name: document.getElementById(`nameField-${safeId}`).value.trim(),
                Skill: document.getElementById(`skillField-${safeId}`).value.trim(),
                Location: document.getElementById(`locationField-${safeId}`).value.trim()
            };
            try {
                const row = workers.find(w => w.Phone === worker.Phone);
                const res = await fetch(`${API_URL}/${row._rowNumber}`, {
                    method: 'PATCH',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(updatedWorker)
                });
                const msgEl = document.getElementById(`msg-${safeId}`);
                if(res.ok){
                    msgEl.style.color = 'green';
                    msgEl.textContent = '✅ Profile updated successfully!';
                    new QRCode(document.getElementById(`qr-${safeId}`), {
                        text: `Name: ${updatedWorker.Name}\nSkill: ${updatedWorker.Skill}\nPhone: ${worker.Phone}\nLocation: ${updatedWorker.Location}`,
                        width: 130,
                        height: 130
                    });
                } else {
                    msgEl.style.color = 'red';
                    msgEl.textContent = '❌ Update failed';
                }
            } catch(err){
                const msgEl = document.getElementById(`msg-${safeId}`);
                msgEl.style.color = 'red';
                msgEl.textContent = '❌ Network error';
            }
        });

        // Download individual PDF
        document.getElementById(`downloadBtn-${safeId}`).addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'mm', format: 'a6' });
            doc.setFontSize(14);
            doc.text(`Name: ${document.getElementById(`nameField-${safeId}`).value}`, 10, 20);
            doc.setFontSize(12);
            doc.text(`Skill: ${document.getElementById(`skillField-${safeId}`).value}`, 10, 30);
            doc.text(`Phone: ${worker.Phone}`, 10, 40);
            doc.text(`Location: ${document.getElementById(`locationField-${safeId}`).value}`, 10, 50);
            doc.save(`${document.getElementById(`nameField-${safeId}`).value}_UnityPass.pdf`);
        });
    });
}

// Multi-field search
findBtn.addEventListener('click', () => {
    const query = searchInput.value.trim().toLowerCase();
    if(!query) return;

    const matchedWorkers = workers.filter(w => 
        (w.Phone && w.Phone.includes(query)) ||
        (w.Name && w.Name.toLowerCase().includes(query)) ||
        (w.Location && w.Location.toLowerCase().includes(query))
    );

    displayWorkers(matchedWorkers);
});

// Bulk download all PDFs
downloadAllBtn.addEventListener('click', () => {
    const matchedCards = document.querySelectorAll('.id-card');
    if(matchedCards.length === 0) {
        alert('No workers to download.');
        return;
    }

    matchedCards.forEach(card => {
        const nameField = card.querySelector('input[id^="nameField"]').value;
        const skillField = card.querySelector('input[id^="skillField"]').value;
        const phoneField = card.querySelector('input[id^="phoneField"]').value;
        const locationField = card.querySelector('input[id^="locationField"]').value;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'mm', format: 'a6' });
        doc.setFontSize(14);
        doc.text(`Name: ${nameField}`, 10, 20);
        doc.setFontSize(12);
        doc.text(`Skill: ${skillField}`, 10, 30);
        doc.text(`Phone: ${phoneField}`, 10, 40);
        doc.text(`Location: ${locationField}`, 10, 50);
        doc.save(`${nameField}_UnityPass.pdf`);
    });
});

loadWorkers();
</script>
</body>
</html>